apiVersion: kuscia.secretflow/v1alpha1
kind: AppImage
metadata:
  name: secretflow-arm64
  annotations:
    load-from: ./secretflow-image.tar
spec:
  image:
    id: fe5305853e5e2e7e36f09677deed2d6ff0f136a354a5bcf9c0efd43da1fbf91b
    name: docker.io/tonywu6/secretflow
    sign: fe5305853e5e2e7e36f09677deed2d6ff0f136a354a5bcf9c0efd43da1fbf91b
    tag: linux-arm64
  configTemplates:
    # envvars in pod
    task-config.conf: |
      {
        "task_id": "{{.TASK_ID}}",
        "task_input_config": "{{.TASK_INPUT_CONFIG}}",
        "task_cluster_def": "{{.TASK_CLUSTER_DEFINE}}",
        "allocated_ports": "{{.ALLOCATED_PORTS}}"
      }
  deployTemplates:
    - name: secretflow
      replicas: 1
      spec:
        containers:
          - command: ['micromamba']
            args:
              - run
              - python
              - -m
              - secretflow.kuscia.entry
              - /tmp/task-config.conf
            name: secretflow
            imagePullPolicy: Never
            workingDir: /tmp
            configVolumeMounts:
              - mountPath: /tmp/task-config.conf
                subPath: task-config.conf
            ports:
              - name: spu
                port: 20000
                protocol: GRPC
                scope: Cluster
              - name: fed
                port: 20001
                protocol: GRPC
                scope: Cluster
              - name: global
                port: 20002
                protocol: GRPC
                scope: Domain
              - name: node-manager
                port: 20003
                protocol: GRPC
                scope: Local
              - name: object-manager
                port: 20004
                protocol: GRPC
                scope: Local
              - name: client-server
                port: 20005
                protocol: GRPC
                scope: Local
        restartPolicy: Never
